<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ルーム制五目並べ</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
  #rooms { display: flex; gap: 20px; margin-bottom: 20px; }
  .room { border: 1px solid #333; padding: 10px; width: 150px; text-align: center; }
  #board { display: grid; grid-template-columns: repeat(15, 30px); grid-template-rows: repeat(15, 30px); gap: 1px; margin-top: 10px; }
  .cell { width: 30px; height: 30px; background: #fff; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
  #message { margin-top: 10px; }
  #controls { margin-top: 10px; }
</style>
</head>
<body>

<h2>ルーム選択</h2>
<div id="rooms"></div>

<div id="game" style="display:none">
  <div id="message"></div>
  <div id="board"></div>
  <div id="controls" style="display:none">
    <button id="rematchBtn">再戦リクエスト</button>
    <button id="leaveBtn">退出</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const roomsEl = document.getElementById('rooms');
const boardEl = document.getElementById('board');
const messageEl = document.getElementById('message');
const gameEl = document.getElementById('game');
const controlsEl = document.getElementById('controls');
const rematchBtn = document.getElementById('rematchBtn');
const leaveBtn = document.getElementById('leaveBtn');

let myTurn = false;
let board = [];
let roomId = null;

// ルーム表示
function renderRooms(rooms) {
  roomsEl.innerHTML = '';
  rooms.forEach(r => {
    const div = document.createElement('div');
    div.className = 'room';
    div.innerHTML = `<div>ルーム${r.id}</div>
                     <div>${r.state==='empty'?'空き':r.state==='waiting'?'相手待機中':'試合中'}</div>
                     <button ${r.state==='playing'?'disabled':''} onclick="joinRoom(${r.id})">入室</button>`;
    roomsEl.appendChild(div);
  });
}

function joinRoom(id){
  socket.emit('joinRoom', id);
}

socket.on('updateRooms', renderRooms);
socket.on('roomFull', ()=>alert('試合中です'));
socket.on('waitingOpponent', ()=>{
  roomId = roomId; // 一人目
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  messageEl.textContent = '対戦相手が入室するのを待っています';
});
socket.on('startGame', data=>{
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  controlsEl.style.display = 'block';
  myTurn = data.yourTurn;
  initBoard();
  messageEl.textContent = myTurn ? 'あなたの番です' : '相手の番です';
});

socket.on('opponentMove', ({x,y})=>{
  board[y][x] = myTurn ? '○' : '●';
  renderBoard();
  myTurn = true;
  messageEl.textContent = 'あなたの番です';
});

socket.on('opponentLeft', ()=>{
  messageEl.textContent = '相手が退出しました';
  controlsEl.style.display = 'none';
  setTimeout(()=>location.reload(), 2000);
});

// 盤面初期化
function initBoard(){
  board = Array.from({length:15},()=>Array(15).fill(null));
  boardEl.innerHTML = '';
  for(let y=0;y<15;y++){
    for(let x=0;x<15;x++){
      const cell = document.createElement('div');
      cell.className='cell';
      cell.dataset.x=x;
      cell.dataset.y=y;
      cell.addEventListener('click', ()=>placeStone(x,y));
      boardEl.appendChild(cell);
    }
  }
}

function renderBoard(){
  for(let y=0;y<15;y++){
    for(let x=0;x<15;x++){
      const cell = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      cell.textContent = board[y][x]||'';
    }
  }
}

function placeStone(x,y){
  if(!myTurn || board[y][x]) return;
  board[y][x] = '●';
  renderBoard();
  myTurn = false;
  messageEl.textContent = '相手の番です';
  socket.emit('move',{x,y});
}

// 再戦
rematchBtn.addEventListener('click', ()=>{
  socket.emit('rematch');
  messageEl.textContent='再戦リクエスト送信済み…相手を待っています';
});

// 退出
leaveBtn.addEventListener('click', ()=>{
  socket.emit('leaveRoom');
  location.reload();
});

</script>
</body>
</html>
