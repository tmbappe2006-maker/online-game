<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ルーム制五目並べ</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
  #rooms { display: flex; gap: 20px; margin-bottom: 20px; }
  .room { border: 1px solid #333; padding: 10px; width: 160px; text-align: center; }
  #board { display: grid; grid-template-columns: repeat(15, 30px); grid-template-rows: repeat(15, 30px); gap: 0; margin-top: 10px; }
  .cell {
    width: 30px; height: 30px; background: #f0d9b5;
    display:flex; align-items:center; justify-content:center;
    border: 1px solid #000; box-sizing: border-box;
    cursor: pointer; user-select: none;
  }
  .cell.disabled { cursor: not-allowed; opacity: .6; }
  .stone { width: 80%; height: 80%; border-radius: 50%; display: block; }
  .stone.black { background: #000; }
  .stone.white { background: #fff; box-shadow: inset 0 0 0 1px #000; }
  #message { margin-top: 12px; min-height: 1.6em; }
  #controls { margin-top: 10px; display: none; gap: 8px; }
  button { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
</style>
</head>
<body>

<h2>ルーム選択</h2>
<div id="rooms"></div>

<div id="game" style="display:none">
  <div id="message"></div>
  <div id="board"></div>
  <div id="controls">
    <button id="rematchBtn" style="display:none">再戦リクエスト</button>
    <button id="leaveBtn">退出</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const roomsEl = document.getElementById('rooms');
const boardEl = document.getElementById('board');
const messageEl = document.getElementById('message');
const gameEl = document.getElementById('game');
const controlsEl = document.getElementById('controls');
const rematchBtn = document.getElementById('rematchBtn');
const leaveBtn = document.getElementById('leaveBtn');

const SIZE = 15;
let roomId = null;
let myTurn = false;
let myColor = null;           // 'black' | 'white'
let oppColor = null;          // 'black' | 'white'
let board = Array.from({length: SIZE}, () => Array(SIZE).fill(null));

// ルーム一覧表示
function renderRooms(rooms) {
  roomsEl.innerHTML = '';
  rooms.forEach(r => {
    const div = document.createElement('div');
    div.className = 'room';
    div.innerHTML = `
      <div><strong>ルーム${r.id}</strong></div>
      <div style="margin:6px 0">${r.state==='empty'?'空き':r.state==='waiting'?'相手待機中':'試合中'}</div>
      <button ${r.state==='playing'?'disabled':''} onclick="joinRoom(${r.id})">入室</button>`;
    roomsEl.appendChild(div);
  });
}

// 入室
function joinRoom(id) {
  socket.emit('joinRoom', id);
}

// 初期板描画
function initBoard(){
  board = Array.from({length: SIZE}, () => Array(SIZE).fill(null));
  boardEl.innerHTML = '';
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.addEventListener('click', () => placeStone(x, y));
      boardEl.appendChild(cell);
    }
  }
  refreshBoardInteractivity();
}

// 盤面→DOM反映
function renderBoard(){
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      while (cell.firstChild) cell.removeChild(cell.firstChild);
      const v = board[y][x];
      if (v) {
        const s = document.createElement('span');
        s.className = `stone ${v}`;
        cell.appendChild(s);
      }
    }
  }
}

// クリック可能状態の更新
function refreshBoardInteractivity(){
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      if (!myTurn || board[y][x]) cell.classList.add('disabled');
      else cell.classList.remove('disabled');
    }
  }
}

function placeStone(x, y){
  if (!myTurn || board[y][x]) return;
  board[y][x] = myColor;
  renderBoard();
  myTurn = false;
  refreshBoardInteractivity();
  messageEl.textContent = '相手の番です';
  socket.emit('move', { x, y });
}

// ===== socket events =====
socket.on('updateRooms', renderRooms);
socket.on('roomFull', () => alert('試合中です'));

// 一人目（待機）
socket.on('waitingOpponent', () => {
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  controlsEl.style.display = 'block';
  rematchBtn.style.display = 'none';
  messageEl.textContent = '対戦相手が入室するのを待っています';
  // 盤面はまだ生成しない（2人目が入って startGame が来たら生成）
});

// 試合開始（yourTurn: true → 先手＝黒、false → 後手＝白）
socket.on('startGame', ({ yourTurn }) => {
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  controlsEl.style.display = 'block';
  rematchBtn.style.display = 'none';

  myTurn = !!yourTurn;
  myColor = myTurn ? 'black' : 'white';
  oppColor = myTurn ? 'white' : 'black';

  initBoard();
  renderBoard();
  messageEl.textContent = myTurn ? 'あなたの番です' : '相手の番です';
});

// 相手の手
socket.on('opponentMove', ({ x, y }) => {
  board[y][x] = oppColor;
  renderBoard();
  myTurn = true;
  refreshBoardInteractivity();
  messageEl.textContent = 'あなたの番です';
});

// 相手が退出
socket.on('opponentLeft', () => {
  // 盤面を消して、戻るボタンを出す。自動では戻らない。
  boardEl.innerHTML = '';
  messageEl.textContent = '相手が退出しました';

  controlsEl.innerHTML = '';
  const backBtn = document.createElement('button');
  backBtn.textContent = 'ルーム選択に戻る';
  backBtn.onclick = () => {
    socket.emit('returnToLobby');  // 自分が戻るタイミングでサーバーに通知
    gameEl.style.display = 'none';
    roomsEl.style.display = 'flex';
    controlsEl.style.display = 'none';
    messageEl.textContent = '';
  };
  controlsEl.appendChild(backBtn);
  controlsEl.style.display = 'block';
});

// 自分が退出
leaveBtn.addEventListener('click', () => {
  socket.emit('exitGame'); // まず相手に「相手が退出しました」を通知
  boardEl.innerHTML = '';
  messageEl.textContent = '退出しました';

  controlsEl.innerHTML = '';
  const backBtn = document.createElement('button');
  backBtn.textContent = 'ルーム選択に戻る';
  backBtn.onclick = () => {
    socket.emit('returnToLobby');  // 自分がロビーへ戻るタイミングで通知
    gameEl.style.display = 'none';
    roomsEl.style.display = 'flex';
    controlsEl.style.display = 'none';
    messageEl.textContent = '';
  };
  controlsEl.appendChild(backBtn);
  controlsEl.style.display = 'block';
});
</script>
</body>
</html>
