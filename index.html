<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ルーム制五目並べ</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
  #rooms { display: flex; gap: 20px; margin-bottom: 20px; }
  .room { border: 1px solid #333; padding: 10px; width: 160px; text-align: center; }
  #board { display: grid; grid-template-columns: repeat(15, 30px); grid-template-rows: repeat(15, 30px); gap: 0; margin-top: 10px; }
  .cell {
    width: 30px; height: 30px; background: #f0d9b5;
    display:flex; align-items:center; justify-content:center;
    border: 1px solid #000; box-sizing: border-box;
    cursor: pointer; user-select: none;
  }
  .cell.disabled { cursor: not-allowed; opacity: .6; }
  .stone { width: 80%; height: 80%; border-radius: 50%; display: block; }
  .stone.black { background: #000; }
  .stone.white { background: #fff; box-shadow: inset 0 0 0 1px #000; }
  #message { margin-top: 12px; min-height: 1.6em; }
  #controls { margin-top: 10px; display: none; gap: 8px; }
  button { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
</style>
</head>
<body>

<h2>ルーム選択</h2>
<div id="rooms"></div>

<div id="game" style="display:none">
  <div id="message"></div>
  <div id="board"></div>
  <div id="controls">
    <button id="leaveBtn">退出</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const roomsEl = document.getElementById('rooms');
const gameEl = document.getElementById('game');
const boardEl = document.getElementById('board');
const messageEl = document.getElementById('message');
const controlsEl = document.getElementById('controls');
const leaveBtn = document.getElementById('leaveBtn');

const SIZE = 15;
let myTurn = false;
let myColor = null;
let oppColor = null;
let board = Array.from({length: SIZE}, () => Array(SIZE).fill(null));

// ルーム一覧
function renderRooms(rooms) {
  roomsEl.innerHTML = '';
  rooms.forEach(r => {
    const label = r.state === 'empty' ? '空き'
                : r.state === 'waiting' ? '相手待機中'
                : '試合中';
    const disabled = r.state === 'playing' ? 'disabled' : '';

    const div = document.createElement('div');
    div.className = 'room';
    div.innerHTML = `
      <div><strong>ルーム${r.id}</strong></div>
      <div style="margin:6px 0">${label}</div>
      <button ${disabled} onclick="joinRoom(${r.id})">入室</button>
    `;
    roomsEl.appendChild(div);
  });
}

window.joinRoom = (id) => {
  socket.emit('joinRoom', id);
};

socket.on('updateRooms', renderRooms);
socket.on('roomFull', () => alert('試合中です'));

// 一人目が入室
socket.on('waitingOpponent', () => {
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  controlsEl.style.display = 'block';
  messageEl.textContent = '対戦相手が入室するのを待っています';
  // 盤面は startGame が来たタイミングで生成
});

// 試合開始（yourTurn: true が先手＝黒）
socket.on('startGame', ({ yourTurn }) => {
  roomsEl.style.display = 'none';
  gameEl.style.display = 'block';
  controlsEl.style.display = 'block';

  myTurn = !!yourTurn;
  myColor = myTurn ? 'black' : 'white';
  oppColor = myTurn ? 'white' : 'black';

  initBoard();
  renderBoard();
  messageEl.textContent = myTurn ? 'あなたの番です' : '相手の番です';
});

// 相手が退出（自動では戻さない）
socket.on('opponentLeft', () => {
  boardEl.innerHTML = '';
  messageEl.textContent = '相手が退出しました';

  // 「ルーム選択に戻る」ボタンを出す
  controlsEl.innerHTML = '';
  const backBtn = document.createElement('button');
  backBtn.textContent = 'ルーム選択に戻る';
  backBtn.onclick = () => {
    socket.emit('returnToLobby');  // 自分が戻る瞬間にサーバーへ通知
    gameEl.style.display = 'none';
    roomsEl.style.display = 'flex';
    controlsEl.style.display = 'none';
    messageEl.textContent = '';
  };
  controlsEl.appendChild(backBtn);
  controlsEl.style.display = 'block';
});

// 自分が退出（自動では戻さない）
leaveBtn.addEventListener('click', () => {
  socket.emit('exitGame');     // 相手に「相手が退出しました」を通知
  boardEl.innerHTML = '';
  messageEl.textContent = '退出しました';

  controlsEl.innerHTML = '';
  const backBtn = document.createElement('button');
  backBtn.textContent = 'ルーム選択に戻る';
  backBtn.onclick = () => {
    socket.emit('returnToLobby'); // 自分が戻る瞬間にサーバーへ通知
    gameEl.style.display = 'none';
    roomsEl.style.display = 'flex';
    controlsEl.style.display = 'none';
    messageEl.textContent = '';
  };
  controlsEl.appendChild(backBtn);
  controlsEl.style.display = 'block';
});

// --- 盤面まわり ---
function initBoard(){
  board = Array.from({length: SIZE}, () => Array(SIZE).fill(null));
  boardEl.innerHTML = '';
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.addEventListener('click', () => placeStone(x, y));
      boardEl.appendChild(cell);
    }
  }
  refreshInteractivity();
}

function renderBoard(){
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      while (cell.firstChild) cell.removeChild(cell.firstChild);
      const v = board[y][x];
      if (v) {
        const s = document.createElement('span');
        s.className = `stone ${v}`;
        cell.appendChild(s);
      }
    }
  }
}

function refreshInteractivity(){
  for(let y=0; y<SIZE; y++){
    for(let x=0; x<SIZE; x++){
      const cell = boardEl.querySelector(`[data-x="${x}"][data-y="${y}"]`);
      if (!myTurn || board[y][x]) cell.classList.add('disabled');
      else cell.classList.remove('disabled');
    }
  }
}

function placeStone(x, y){
  if (!myTurn || board[y][x]) return;
  board[y][x] = myColor;
  renderBoard();
  myTurn = false;
  refreshInteractivity();
  messageEl.textContent = '相手の番です';
  socket.emit('move', { x, y });
}

socket.on('opponentMove', ({ x, y }) => {
  board[y][x] = oppColor;
  renderBoard();
  myTurn = true;
  refreshInteractivity();
  messageEl.textContent = 'あなたの番です';
});
</script>
</body>
</html>
